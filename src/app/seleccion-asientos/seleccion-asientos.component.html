<!-- Seat Selection Page -->
<div class="seat-selection-page">
  <!-- Header Section -->
  <section class="page-header">
    <div class="header-container">
      <!-- Navigation -->
      <div class="header-nav">
        <button class="btn-back" (click)="goBack()">
          <i class="fas fa-arrow-left"></i>
          Volver
        </button>
        <h1 class="page-title">Selección de Asientos</h1>
      </div>

      <!-- Movie Information Header -->
      <div class="movie-header" *ngIf="movieDetails">
        <img
          [src]="'https://image.tmdb.org/t/p/w300/' + movieDetails.poster_path"
          [alt]="movieDetails.title"
          class="movie-poster-small"
          *ngIf="movieDetails.poster_path"
        />
        <div class="movie-info">
          <h2 class="movie-title">{{ movieDetails.title }}</h2>
          <div class="movie-meta">
            <span class="meta-item">
              <i class="fas fa-calendar"></i>
              {{ movieDetails.release_date | date : "yyyy" }}
            </span>
            <span class="meta-item">
              <i class="fas fa-star"></i>
              {{ movieDetails.vote_average | number : "1.1" }}
            </span>
            <span class="meta-item">
              <i class="fas fa-clock"></i>
              120 min
            </span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="main-content">
    <!-- No Estreno Message -->
    <div *ngIf="!esEstreno" class="success-message">
      <h2 class="success-title">Película no disponible</h2>
      <p class="success-description">
        Esta película no está disponible para compra de entradas en este
        momento.
      </p>
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
        Volver al catálogo
      </button>
    </div>

    <!-- Selection Process -->
    <div *ngIf="esEstreno">
      <!-- Step Cards -->
      <div class="selection-steps">
        <!-- Step 1: Cinema Selection -->
        <div class="step-card" [class.active]="currentStep === 1">
          <div class="step-header">
            <div class="step-number">1</div>
            <h3 class="step-title">Selecciona tu cine</h3>
          </div>
          <div class="form-group">
            <label for="sucursal" class="form-label">
              <i class="fas fa-map-marker-alt"></i>
              Sucursal
            </label>
            <select
              id="sucursal"
              class="form-select"
              [(ngModel)]="sucursalSeleccionada"
              (change)="onSucursalChange(sucursalSeleccionada)"
            >
              <option value="">Selecciona una sucursal...</option>
              <option
                *ngFor="let sucursal of sucursales"
                [value]="sucursal.NOMBRE"
              >
                {{ sucursal.NOMBRE }}
              </option>
            </select>
          </div>
        </div>

        <!-- Step 2: Schedule and Seat Selection -->
        <div class="step-card" [class.active]="currentStep === 2">
          <div class="step-header">
            <div class="step-number">2</div>
            <h3 class="step-title">Elige horario y asientos</h3>
          </div>
          <div class="form-group" *ngIf="sucursalSeleccionada">
            <label for="horario" class="form-label">
              <i class="fas fa-clock"></i>
              Horario de función
            </label>
            <select
              id="horario"
              class="form-select"
              [(ngModel)]="horarioSeleccionado"
              (change)="onHorarioChange(horarioSeleccionado)"
            >
              <option value="">Selecciona un horario...</option>
              <option *ngFor="let hora of horariosPorSucursal" [value]="hora">
                {{ hora }}
              </option>
            </select>
          </div>
          <div *ngIf="!sucursalSeleccionada" class="form-group">
            <p style="color: #666; font-style: italic">
              Primero selecciona una sucursal
            </p>
          </div>
        </div>
      </div>

      <!-- Seat Selection -->
      <div *ngIf="puedeSeleccionarAsientos" class="seat-selection-container">
        <h3 class="seats-title">
          <i class="fas fa-couch"></i>
          Selecciona tus asientos
        </h3>

        <div class="screen"></div>

        <!-- Mensaje cuando no hay asientos disponibles -->
        <div *ngIf="filasAsientos.length === 0" class="no-seats-message">
          <p>No hay asientos disponibles para este horario.</p>
          <p>Por favor, selecciona otro horario.</p>
        </div>

        <!-- Grid de asientos cuando hay datos -->
        <div *ngIf="filasAsientos.length > 0" class="seats-grid">
          <div *ngFor="let fila of filasAsientos" class="seat-row">
            <span
              class="row-label"
              >{{ fila[0]?.nombre?.[0] || fila[0]?.ASIENTO?.[0] }}</span
            >
            <span
              *ngFor="let asiento of fila"
              class="seat"
              [class.selected]="asientosSeleccionados.includes(asiento)"
              [class.occupied]="asiento.ocupado"
              (click)="seleccionarAsiento(asiento)"
            >
              {{ asiento.nombre?.slice(1) || asiento.ASIENTO?.slice(1) }}
            </span>
          </div>
        </div>

        <div class="seat-legend">
          <div class="legend-item">
            <div class="legend-seat legend-available"></div>
            <span>Disponible</span>
          </div>
          <div class="legend-item">
            <div class="legend-seat legend-selected"></div>
            <span>Seleccionado</span>
          </div>
          <div class="legend-item">
            <div class="legend-seat legend-occupied"></div>
            <span>Ocupado</span>
          </div>
        </div>
      </div>

      <!-- Step 3: Customer Information and Payment -->
      <div *ngIf="currentStep === 3" class="step-card active">
        <div class="step-header">
          <div class="step-number">3</div>
          <h3 class="step-title">Datos del cliente y pago</h3>
        </div>

        <!-- Customer Information -->
        <div class="customer-info-section">
          <h4 class="section-title">
            <i class="fas fa-user"></i>
            Información del cliente
          </h4>

          <div class="form-row">
            <div class="form-group">
              <label for="customerName" class="form-label"
                >Nombre completo *</label
              >
              <input
                type="text"
                id="customerName"
                class="form-input"
                [(ngModel)]="customerInfo.name"
                placeholder="Ingresa tu nombre completo"
                required
              />
            </div>
            <div class="form-group">
              <label for="customerEmail" class="form-label">Email *</label>
              <input
                type="email"
                id="customerEmail"
                class="form-input"
                [(ngModel)]="customerInfo.email"
                placeholder="tu-email@ejemplo.com"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="customerPhone" class="form-label">Teléfono *</label>
              <input
                type="tel"
                id="customerPhone"
                class="form-input"
                [(ngModel)]="customerInfo.phone"
                placeholder="+54 11 1234-5678"
                required
              />
            </div>
            <div class="form-group">
              <label for="documentType" class="form-label"
                >Tipo de documento *</label
              >
              <select
                id="documentType"
                class="form-select"
                [(ngModel)]="customerInfo.documentType"
                required
              >
                <option value="DNI">DNI</option>
                <option value="Pasaporte">Pasaporte</option>
                <option value="Cédula">Cédula</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="documentNumber" class="form-label"
                >Número de documento *</label
              >
              <input
                type="text"
                id="documentNumber"
                class="form-input"
                [(ngModel)]="customerInfo.documentNumber"
                placeholder="12345678"
                required
              />
            </div>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="payment-section">
          <h4 class="section-title">
            <i class="fas fa-credit-card"></i>
            Método de pago
          </h4>

          <div class="payment-methods">
            <label class="payment-option">
              <input
                type="radio"
                name="paymentMethod"
                value="credit-card"
                [(ngModel)]="paymentMethod"
                (ngModelChange)="onPaymentMethodChange()"
              />
              <div class="option-content">
                <i class="fas fa-credit-card"></i>
                <span>Tarjeta de Crédito/Débito</span>
              </div>
            </label>

            <label class="payment-option">
              <input
                type="radio"
                name="paymentMethod"
                value="mercado-pago"
                [(ngModel)]="paymentMethod"
                (ngModelChange)="onPaymentMethodChange()"
              />
              <div class="option-content">
                <i class="fab fa-paypal"></i>
                <span>Mercado Pago</span>
              </div>
            </label>

            <label class="payment-option">
              <input
                type="radio"
                name="paymentMethod"
                value="cash-pickup"
                [(ngModel)]="paymentMethod"
                (ngModelChange)="onPaymentMethodChange()"
              />
              <div class="option-content">
                <i class="fas fa-hand-holding-usd"></i>
                <span>Pago en el Local</span>
              </div>
            </label>
          </div>

          <!-- Credit Card Form -->
          <div class="card-form" *ngIf="paymentMethod === 'credit-card'">
            <div class="form-row">
              <div class="form-group">
                <label for="cardName" class="form-label"
                  >Nombre en la tarjeta</label
                >
                <input
                  type="text"
                  id="cardName"
                  class="form-input"
                  [(ngModel)]="cardName"
                  (ngModelChange)="onCardNameChange()"
                  placeholder="Nombre como aparece en la tarjeta"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="cardNumber" class="form-label"
                  >Número de tarjeta</label
                >
                <input
                  type="text"
                  id="cardNumber"
                  class="form-input"
                  [(ngModel)]="cardNumber"
                  (ngModelChange)="onCardNumberChange()"
                  placeholder="1234 5678 9012 3456"
                  maxlength="19"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="cardExpiry" class="form-label"
                  >Fecha de vencimiento</label
                >
                <input
                  type="text"
                  id="cardExpiry"
                  class="form-input"
                  [(ngModel)]="cardExpiry"
                  (ngModelChange)="onCardExpiryChange()"
                  placeholder="MM/AA"
                  maxlength="5"
                />
              </div>
              <div class="form-group">
                <label for="cardCvv" class="form-label">CVV</label>
                <input
                  type="text"
                  id="cardCvv"
                  class="form-input"
                  [(ngModel)]="cardCvv"
                  (ngModelChange)="onCardCvvChange()"
                  placeholder="123"
                  maxlength="4"
                />
              </div>
            </div>
          </div>

          <!-- Mercado Pago Info -->
          <div class="info-card" *ngIf="paymentMethod === 'mercado-pago'">
            <i class="fab fa-paypal info-icon"></i>
            <p>
              Serás redirigido a Mercado Pago para completar el pago de forma
              segura.
            </p>
          </div>

          <!-- Cash Pickup Info -->
          <div class="info-card" *ngIf="paymentMethod === 'cash-pickup'">
            <i class="fas fa-store info-icon"></i>
            <p>Podrás pagar en efectivo al retirar tus entradas en el cine.</p>
            <p>
              <strong>Sucursal seleccionada:</strong> {{ sucursalSeleccionada }}
            </p>
          </div>
        </div>
      </div>

      <!-- Step 4: Confirmation -->
      <div *ngIf="currentStep === 4" class="step-card active">
        <div class="step-header">
          <div class="step-number">4</div>
          <h3 class="step-title">Confirmación</h3>
        </div>

        <div class="confirmation-section">
          <h4 class="section-title">
            <i class="fas fa-check-circle"></i>
            Confirma tu compra
          </h4>

          <div class="confirmation-details">
            <div class="detail-group">
              <h5>
                <i class="fas fa-film"></i>
                Detalles de la función
              </h5>
              <p><strong>Película:</strong> {{ movieDetails?.title }}</p>
              <p><strong>Sucursal:</strong> {{ sucursalSeleccionada }}</p>
              <p><strong>Horario:</strong> {{ horarioSeleccionado }}</p>
              <p>
                <strong>Asientos:</strong>
                {{ asientosSeleccionados.map(a => a.ASIENTO).join(', ') }}
              </p>
            </div>

            <div class="detail-group">
              <h5>
                <i class="fas fa-user"></i>
                Datos del cliente
              </h5>
              <p><strong>Nombre:</strong> {{ customerInfo.name }}</p>
              <p><strong>Email:</strong> {{ customerInfo.email }}</p>
              <p><strong>Teléfono:</strong> {{ customerInfo.phone }}</p>
              <p>
                <strong>{{ customerInfo.documentType }}:</strong>
                {{ customerInfo.documentNumber }}
              </p>
            </div>

            <div class="detail-group">
              <h5>
                <i class="fas fa-credit-card"></i>
                Método de pago
              </h5>
              <p *ngIf="paymentMethod === 'credit-card'">
                Tarjeta de crédito terminada en
                {{ cardNumber?.slice(-4) || "****" }}
              </p>
              <p *ngIf="paymentMethod === 'mercado-pago'">Mercado Pago</p>
              <p *ngIf="paymentMethod === 'cash-pickup'">
                Pago en el local - {{ sucursalSeleccionada }}
              </p>
            </div>
          </div>

          <div class="terms-section">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="termsAccepted" required />
              <span class="checkmark"></span>
              Acepto los
              <a href="/terms" target="_blank">términos y condiciones</a>
            </label>
          </div>
        </div>
      </div>

      <!-- Purchase Summary -->
      <div *ngIf="asientosSeleccionados.length > 0" class="purchase-summary">
        <h3 class="summary-title">
          <i class="fas fa-receipt"></i>
          Resumen de compra
        </h3>

        <div class="summary-item">
          <span class="summary-label">Película:</span>
          <span class="summary-value">{{ movieDetails?.title }}</span>
        </div>

        <div class="summary-item">
          <span class="summary-label">Sucursal:</span>
          <span class="summary-value">{{ sucursalSeleccionada }}</span>
        </div>

        <div class="summary-item">
          <span class="summary-label">Horario:</span>
          <span class="summary-value">{{ horarioSeleccionado }}</span>
        </div>

        <div class="summary-item">
          <span class="summary-label">Asientos:</span>
          <span class="summary-value">
            <span
              *ngFor="let asiento of asientosSeleccionados; let last = last"
            >
              {{ asiento.nombre || asiento.ASIENTO
              }}<span *ngIf="!last">, </span>
            </span>
          </span>
        </div>

        <div class="summary-item">
          <span class="summary-label">Cantidad:</span>
          <span class="summary-value"
            >{{ asientosSeleccionados.length }} entrada(s)</span
          >
        </div>

        <div class="summary-item">
          <span class="summary-label">Subtotal:</span>
          <span class="summary-value">{{
            precioSubtotal | currency : "ARS $"
          }}</span>
        </div>

        <!-- Descuento Social -->
        <div class="summary-item discount-section" *ngIf="tieneDescuentoSocial">
          <div class="discount-info">
            <i class="fas fa-heart discount-icon"></i>
            <div class="discount-details">
              <span class="discount-title"
                >Descuento Social ({{ descuentoPorcentaje }}%)</span
              >
              <span class="discount-type">{{ tipoDescuento }}</span>
            </div>
            <span class="discount-amount"
              >-{{ montoDescuento | currency : "ARS $" }}</span
            >
          </div>
        </div>

        <!-- Descuento PeliRandom -->
        <div
          class="summary-item discount-section pelirandom-discount"
          *ngIf="tieneDescuentoPeliRandom"
        >
          <div class="discount-info">
            <i class="fas fa-dice discount-icon"></i>
            <div class="discount-details">
              <span class="discount-title"
                >Descuento PeliRandom ({{
                  descuentoPorcentajePeliRandom
                }}%)</span
              >
              <span class="discount-type">Búsqueda aleatoria de películas</span>
            </div>
            <span class="discount-amount"
              >-{{ montoDescuentoPeliRandom | currency : "ARS $" }}</span
            >
          </div>
        </div>

        <!-- Total de descuentos (si hay múltiples) -->
        <div
          class="summary-item total-discount-section"
          *ngIf="tieneDescuentoSocial && tieneDescuentoPeliRandom"
        >
          <div class="total-discount-info">
            <div class="total-discount-details">
              <span class="total-discount-title"
                >Total Descuentos ({{ descuentoPorcentajeTotal }}%)</span
              >
            </div>
            <span class="total-discount-amount"
              >-{{ montoDescuentoTotal | currency : "ARS $" }}</span
            >
          </div>
        </div>

        <div class="summary-item total-section">
          <span class="summary-label">Total:</span>
          <span class="summary-value total-amount">{{
            precioTotal | currency : "ARS $"
          }}</span>
        </div>

        <!-- Navigation Buttons -->
        <div class="button-container">
          <button
            *ngIf="currentStep > 1"
            class="btn btn-secondary"
            (click)="previousStep()"
          >
            <i class="fas fa-arrow-left"></i>
            Anterior
          </button>

          <button
            *ngIf="currentStep < 4"
            class="btn btn-primary"
            [disabled]="!canProceed()"
            (click)="nextStep()"
          >
            <i class="fas fa-arrow-right"></i>
            <span *ngIf="currentStep === 1">Seleccionar horario</span>
            <span *ngIf="currentStep === 2">Ir a pago</span>
            <span *ngIf="currentStep === 3">Revisar compra</span>
          </button>

          <button
            *ngIf="currentStep === 4"
            class="btn btn-success"
            [disabled]="!canConfirm() || isProcessing"
            (click)="processOrder()"
          >
            <i class="fas fa-spinner fa-spin" *ngIf="isProcessing"></i>
            <i class="fas fa-ticket-alt" *ngIf="!isProcessing"></i>
            <span *ngIf="isProcessing">Procesando...</span>
            <span *ngIf="!isProcessing">Confirmar compra</span>
          </button>
        </div>
      </div>

      <!-- Success Message -->
      <div *ngIf="compraConfirmada" class="success-message">
        <h2 class="success-title">✨ ¡Gracias por tu compra! ✨</h2>
        <p class="success-description">
          Tu compra ha sido confirmada con éxito. Hemos generado un PDF con los
          detalles de tu compra y el código QR. ¡Disfruta de tu película! 🎬
        </p>
        <div class="button-container">
          <button
            class="btn btn-secondary"
            (click)="redirigirAPaginaPrincipal()"
          >
            <i class="fas fa-home"></i>
            Volver al inicio
          </button>
        </div>
      </div>
    </div>
  </section>
</div>
